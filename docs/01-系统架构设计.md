# 系统架构设计文档

## 1. 概述

### 1.1 项目目标
开发一个基于 React + Expo 的移动端本地视频播放应用，为开发者提供类似抖音的沉浸式视频播放体验。

### 1.2 核心功能
- 视频文件管理（上传、删除、组织）
- 视频播放控制（播放、暂停、倍速、进度）
- 抖音风格交互（垂直滑动、手势控制）
- 播放进度管理（书签、历史记录）
- 状态持久化（播放状态、用户设置）

## 2. 技术架构

### 2.1 技术栈选择

#### 前端框架
- **React Native + Expo**: 跨平台移动应用开发框架
- **TypeScript**: 类型安全的 JavaScript 超集
- **Expo Router**: 基于 React Navigation 的路由系统

#### 状态管理
- **Zustand**: 轻量级状态管理库
- **Zustand Persist**: 状态持久化中间件
- **React Context**: 全局状态共享

#### 数据库
- **SQLite**: 本地数据库
- **Drizzle ORM**: 类型安全的 ORM
- **Expo SQLite**: SQLite 数据库驱动

#### UI/UX
- **NativeWind**: Tailwind CSS for React Native
- **React Native Reanimated**: 高性能动画库
- **React Native Gesture Handler**: 手势处理
- **Radix UI**: 无障碍 UI 组件库

#### 视频处理
- **Expo AV**: 音视频播放
- **Expo Video Thumbnails**: 视频缩略图生成
- **Expo Document Picker**: 文件选择器

### 2.2 架构模式

#### 分层架构
```
┌─────────────────────────────────────────┐
│                UI Layer                  │
├─────────────────────────────────────────┤
│             Business Logic              │
├─────────────────────────────────────────┤
│              State Management           │
├─────────────────────────────────────────┤
│               Data Layer                │
├─────────────────────────────────────────┤
│            Storage Layer                │
└─────────────────────────────────────────┘
```

#### 模块化设计
```
src/
├── features/           # 功能模块
│   ├── video/         # 视频播放
│   ├── playlist/      # 播放列表
│   ├── upload/        # 文件上传
│   ├── settings/      # 设置
│   └── search/        # 搜索
├── components/        # 共享组件
├── hooks/            # 自定义 Hooks
├── stores/           # Zustand 状态管理
├── db/              # 数据库相关
└── utils/           # 工具函数
```

## 3. 核心模块设计

### 3.1 视频播放模块

#### 组件结构
```
VideoPlayer/
├── VideoContainer/      # 视频容器
├── VideoControls/       # 播放控制
├── VideoOverlay/        # 覆盖层
├── VideoInfo/          # 视频信息
└── VideoActions/       # 操作按钮
```

#### 状态管理
```typescript
interface VideoState {
  currentVideo: Video | null;
  isPlaying: boolean;
  volume: number;
  playbackRate: number;
  position: number;
  duration: number;
  isLoading: boolean;
  error: string | null;
}
```

#### 手势处理
- **垂直滑动**: 切换视频
- **单击**: 播放/暂停
- **长按**: 倍速选择
- **双击**: 收藏/点赞
- **左右滑动**: 调节音量/亮度

### 3.2 文件管理模块

#### 数据模型
```typescript
interface Video {
  id: string;
  title: string;
  filePath: string;
  thumbnailPath?: string;
  duration: number;
  fileSize: number;
  format: string;
  resolution: {
    width: number;
    height: number;
  };
  createdAt: Date;
  updatedAt: Date;
  tags: string[];
  category: string;
  watchProgress: number;
  isFavorite: boolean;
}
```

#### 文件操作
- **上传**: 支持单文件、多文件、文件夹
- **删除**: 删除文件和数据库记录
- **移动**: 在文件夹间移动
- **重命名**: 修改文件名

### 3.3 状态管理设计

#### Store 结构
```typescript
// 视频播放状态
interface VideoStore {
  videos: Video[];
  currentVideo: Video | null;
  playbackState: PlaybackState;
  favorites: Video[];
  watchHistory: WatchRecord[];
  
  // Actions
  playVideo: (video: Video) => void;
  pauseVideo: () => void;
  toggleFavorite: (videoId: string) => void;
  updateProgress: (videoId: string, progress: number) => void;
}

// 用户设置状态
interface SettingsStore {
  theme: 'light' | 'dark';
  playbackSpeed: number;
  defaultVolume: number;
  autoPlay: boolean;
  loopMode: 'none' | 'single' | 'all';
  
  // Actions
  updateSettings: (settings: Partial<SettingsStore>) => void;
  resetSettings: () => void;
}
```

#### 状态持久化
```typescript
const useVideoStore = create<VideoStore>()(
  persist(
    (set, get) => ({
      // store implementation
    }),
    {
      name: 'video-storage',
      storage: createJSONStorage(() => AsyncStorage),
      partialize: (state) => ({
        favorites: state.favorites,
        watchHistory: state.watchHistory,
      }),
    }
  )
);
```

## 4. 数据库设计

### 4.1 数据表结构

#### videos 表
```sql
CREATE TABLE videos (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  file_path TEXT NOT NULL UNIQUE,
  thumbnail_path TEXT,
  duration INTEGER NOT NULL,
  file_size INTEGER NOT NULL,
  format TEXT NOT NULL,
  width INTEGER,
  height INTEGER,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  tags TEXT DEFAULT '[]',
  category TEXT DEFAULT 'uncategorized',
  watch_progress INTEGER DEFAULT 0,
  is_favorite BOOLEAN DEFAULT FALSE,
  play_count INTEGER DEFAULT 0
);
```

#### watch_history 表
```sql
CREATE TABLE watch_history (
  id TEXT PRIMARY KEY,
  video_id TEXT NOT NULL,
  position INTEGER NOT NULL,
  duration INTEGER NOT NULL,
  watched_at TEXT DEFAULT CURRENT_TIMESTAMP,
  completed BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE
);
```

#### playlists 表
```sql
CREATE TABLE playlists (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
  video_count INTEGER DEFAULT 0
);
```

#### playlist_videos 表
```sql
CREATE TABLE playlist_videos (
  playlist_id TEXT NOT NULL,
  video_id TEXT NOT NULL,
  position INTEGER NOT NULL,
  added_at TEXT DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (playlist_id, video_id),
  FOREIGN KEY (playlist_id) REFERENCES playlists(id) ON DELETE CASCADE,
  FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE
);
```

### 4.2 数据库操作

#### 查询优化
- 为常用查询字段创建索引
- 使用全文搜索优化视频搜索
- 实现分页查询提高性能

#### 数据同步
- 实现数据库版本管理
- 支持数据备份和恢复
- 处理并发访问冲突

## 5. 性能优化

### 5.1 视频播放优化

#### 预加载策略
```typescript
// 预加载相邻视频
const preloadAdjacentVideos = (currentVideo: Video) => {
  const currentIndex = videos.findIndex(v => v.id === currentVideo.id);
  const prevVideo = videos[currentIndex - 1];
  const nextVideo = videos[currentIndex + 1];
  
  if (prevVideo) preloadVideo(prevVideo);
  if (nextVideo) preloadVideo(nextVideo);
};
```

#### 内存管理
- 及时释放未使用的视频资源
- 实现视频缓存清理机制
- 监控内存使用情况

### 5.2 UI 性能优化

#### 列表性能
- 使用 FlashList 或 FlatList 优化长列表
- 实现虚拟滚动减少渲染节点
- 使用 memoization 优化组件渲染

#### 动画性能
- 使用 useNativeDriver 提升动画性能
- 减少 JavaScript 线程负担
- 优化手势响应延迟

## 6. 错误处理

### 6.1 错误类型

#### 视频播放错误
- 文件不存在或损坏
- 格式不支持
- 解码错误
- 网络错误（如果支持流媒体）

#### 文件操作错误
- 存储空间不足
- 权限被拒绝
- 文件被占用

### 6.2 错误处理策略

#### 全局错误处理
```typescript
// 全局错误边界
class GlobalErrorBoundary extends React.Component {
  static getDerivedStateFromError(error: Error) {
    return { hasError: true };
  }
  
  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logError(error, errorInfo);
  }
}
```

#### 错误恢复机制
- 自动重试失败的播放操作
- 提供用户友好的错误提示
- 实现降级功能保证基本可用性

## 7. 安全考虑

### 7.1 数据安全

#### 文件访问控制
- 使用系统文件选择器限制访问范围
- 验证文件类型防止恶意文件
- 实现文件完整性检查

#### 数据加密
- 敏感配置信息加密存储
- 用户数据加密保护
- 安全的数据传输机制

### 7.2 隐私保护

#### 数据收集
- 不收集用户隐私数据
- 本地数据处理不上传云端
- 透明的数据处理政策

## 8. 可扩展性设计

### 8.1 插件系统

#### 功能扩展点
- 视频格式解码器
- 字幕支持插件
- 云同步服务

### 8.2 主题系统

#### 主题定制
- 支持自定义主题颜色
- 动态主题切换
- 主题扩展机制

## 9. 开发规范

### 9.1 代码规范

#### TypeScript 规范
- 严格类型检查
- 接口优先设计
- 完善的类型定义

#### 组件规范
- 函数式组件优先
- 自定义 Hook 封装逻辑
- 组件单一职责原则

### 9.2 文档规范

#### 代码文档
- JSDoc 注释规范
- API 文档自动生成
- 架构决策记录

#### 用户文档
- 功能使用说明
- 常见问题解答
- 版本更新日志

## 10. 部署策略

### 10.1 构建配置

#### 环境配置
- 开发环境配置
- 测试环境配置
- 生产环境配置

#### 优化配置
- 代码分割策略
- 资源压缩优化
- 包体积分析

### 10.2 发布流程

#### 版本管理
- 语义化版本控制
- 更新日志生成
- 版本回滚机制

#### 应用商店发布
- iOS App Store 发布流程
- Android Google Play 发布流程
- 自动化构建和发布

---

**文档版本**: 1.0  
**创建日期**: 2025-08-10  
**最后更新**: 2025-08-10