# 数据库使用示例

本文档提供了如何使用 Videotape 应用数据库系统的示例和最佳实践。

## 快速开始

### 1. 初始化数据库

```typescript
import { databaseManager, databaseService } from '@/db/database-manager';

// 初始化数据库
async function initializeAppDatabase() {
  try {
    // 初始化数据库连接
    await databaseManager.initialize();
    
    // 运行数据库迁移
    await databaseManager.runMigrations();
    
    console.log('Database initialized successfully');
  } catch (error) {
    console.error('Failed to initialize database:', error);
  }
}
```

### 2. 基础视频操作

```typescript
import { databaseService } from '@/db/database-service';

// 创建视频
const video = await databaseService.createVideo({
  title: 'My Awesome Video',
  filePath: '/path/to/video.mp4',
  duration: 120, // 秒
  fileSize: 1024000, // 字节
  format: 'mp4',
  resolutionWidth: 1920,
  resolutionHeight: 1080,
  category: 'entertainment',
  description: 'An awesome video for demonstration',
});

// 获取视频
const retrievedVideo = await databaseService.getVideoById(video.id);

// 更新视频
const updatedVideo = await databaseService.updateVideo(video.id, {
  title: 'Updated Video Title',
  description: 'Updated description',
  isFavorite: true,
});

// 搜索视频
const searchResults = await databaseService.searchVideos({
  query: 'awesome',
  category: 'entertainment',
  isFavorite: true,
  sortBy: 'created_at',
  sortOrder: 'desc',
  page: 1,
  pageSize: 20,
});
```

### 3. 播放列表管理

```typescript
// 创建播放列表
const playlist = await databaseService.createPlaylist({
  name: 'My Favorites',
  description: 'My favorite videos collection',
  isPublic: false,
});

// 添加视频到播放列表
await databaseService.addVideoToPlaylist(playlist.id, video.id, {
  customTitle: 'Favorite Video',
  notes: 'This is my most favorite video',
});

// 获取播放列表及其视频
const playlistWithVideos = await databaseService.getPlaylistWithVideos(playlist.id);
console.log('Playlist:', playlistWithVideos?.name);
console.log('Videos:', playlistWithVideos?.videos);
```

### 4. 标签系统

```typescript
// 创建标签
const tag = await databaseService.createTag({
  name: 'Educational',
  color: '#3B82F6',
  description: 'Educational content',
});

// 为视频添加标签
await databaseService.addTagToVideo(video.id, tag.id);

// 获取所有标签
const allTags = await databaseService.getAllTags();
console.log('Available tags:', allTags);
```

### 5. 观看历史记录

```typescript
// 记录观看历史
const watchHistory = await databaseService.recordWatchHistory({
  videoId: video.id,
  position: 60, // 当前观看位置（秒）
  duration: 120, // 视频总时长（秒）
  watchTime: 60, // 实际观看时长（秒）
  sessionId: 'session-123',
  deviceId: 'device-456',
  playbackSpeed: 1.5,
});

// 获取视频的观看历史
const videoHistory = await databaseService.getVideoWatchHistory(video.id);
console.log('Watch history:', videoHistory);
```

### 6. 用户设置管理

```typescript
// 获取用户设置
const settings = await databaseService.getSettings();
console.log('Current settings:', settings);

// 更新用户设置
const updatedSettings = await databaseService.updateSettings({
  theme: 'dark',
  defaultPlaybackSpeed: 1.5,
  defaultVolume: 0.8,
  autoPlay: false,
  loopMode: 'all',
  enableGestures: true,
  enableHaptics: true,
  maxCacheSize: 2048,
  autoCleanupCache: true,
});
```

### 7. 文件夹管理

```typescript
// 创建文件夹
const folder = await databaseService.createFolder({
  name: 'Movies',
  path: '/videos/movies',
  description: 'Movie collection',
  sortOrder: 'name_asc',
  viewMode: 'grid',
});

// 获取文件夹内容
const folderContents = await databaseService.getFolderWithContents(folder.id);
console.log('Folder:', folderContents?.name);
console.log('Videos:', folderContents?.videos);
console.log('Subfolders:', folderContents?.children);
```

### 8. 书签管理

```typescript
// 创建书签
const bookmark = await databaseService.createBookmark({
  videoId: video.id,
  title: 'Important Scene',
  position: 90, // 书签位置（秒）
  description: 'Key moment in the video',
  color: '#EF4444',
});

// 获取视频的书签
const videoBookmarks = await databaseService.getVideoBookmarks(video.id);
console.log('Bookmarks:', videoBookmarks);
```

### 9. 统计信息

```typescript
// 获取视频统计信息
const videoStats = await databaseService.getVideoStats();
console.log('Video statistics:', videoStats);
// 输出示例:
// {
//   totalVideos: 100,
//   totalDuration: 7200,
//   totalSize: 1073741824,
//   totalPlayCount: 500,
//   averageRating: 4.2,
//   categories: { entertainment: 50, educational: 30, documentary: 20 }
// }

// 获取用户统计信息
const userStats = await databaseService.getUserStats();
console.log('User statistics:', userStats);
// 输出示例:
// {
//   totalWatchTime: 3600,
//   videosWatched: 25,
//   playlistsCreated: 5,
//   bookmarksCreated: 10,
//   favoriteVideos: 15
// }

// 获取推荐视频
const recommendedVideos = await databaseService.getRecommendedVideos(10);
console.log('Recommended videos:', recommendedVideos);
```

## 高级功能

### 1. 数据库备份和恢复

```typescript
// 创建备份
const backupPath = await databaseManager.createBackup();
console.log('Backup created at:', backupPath);

// 获取备份信息
const backupInfo = await databaseManager.getBackupInfo();
console.log('Available backups:', backupInfo);

// 从备份恢复
const restoreSuccess = await databaseManager.restoreFromBackup(backupPath);
console.log('Restore success:', restoreSuccess);

// 清理旧备份
await databaseManager.cleanupOldBackups(5); // 保留最近5个备份
```

### 2. 数据库健康检查

```typescript
// 检查数据库健康状态
const healthStatus = await databaseManager.checkHealth();
console.log('Database health:', healthStatus);

if (healthStatus.status === 'error') {
  // 处理错误情况
  console.error('Database issues:', healthStatus.issues);
}
```

### 3. 数据导入导出

```typescript
// 导出数据
const jsonData = await databaseManager.exportData();
console.log('Data exported:', jsonData.length, 'characters');

// 保存到文件
import * as FileSystem from 'expo-file-system';
const exportPath = `${FileSystem.documentDirectory}export.json`;
await FileSystem.writeAsStringAsync(exportPath, jsonData);

// 导入数据
const importData = await FileSystem.readAsStringAsync(exportPath);
const importSuccess = await databaseManager.importData(importData);
console.log('Import success:', importSuccess);
```

## React Hook 集成

### 1. 创建自定义 Hook

```typescript
// hooks/useDatabase.ts
import { useState, useEffect } from 'react';
import { databaseService } from '@/db/database-service';

export function useVideos() {
  const [videos, setVideos] = useState<Video[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const loadVideos = async () => {
    try {
      setLoading(true);
      setError(null);
      const result = await databaseService.searchVideos({
        page: 1,
        pageSize: 50,
      });
      setVideos(result.items);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load videos');
    } finally {
      setLoading(false);
    }
  };

  const searchVideos = async (query: string) => {
    try {
      setLoading(true);
      const result = await databaseService.searchVideos({
        query,
        page: 1,
        pageSize: 50,
      });
      setVideos(result.items);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to search videos');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadVideos();
  }, []);

  return {
    videos,
    loading,
    error,
    refresh: loadVideos,
    search: searchVideos,
  };
}
```

### 2. 使用 Hook 的组件示例

```typescript
// components/VideoList.tsx
import React from 'react';
import { useVideos } from '../hooks/useDatabase';
import { VideoCard } from './VideoCard';

export function VideoList() {
  const { videos, loading, error, refresh, search } = useVideos();

  if (loading) {
    return <div>Loading videos...</div>;
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  return (
    <div>
      <input
        type="text"
        placeholder="Search videos..."
        onChange={(e) => search(e.target.value)}
      />
      <button onClick={refresh}>Refresh</button>
      
      <div className="video-grid">
        {videos.map((video) => (
          <VideoCard key={video.id} video={video} />
        ))}
      </div>
    </div>
  );
}
```

## 最佳实践

### 1. 错误处理

```typescript
async function safeDatabaseOperation<T>(
  operation: () => Promise<T>,
  errorMessage: string
): Promise<T | null> {
  try {
    return await operation();
  } catch (error) {
    console.error(errorMessage, error);
    // 可以在这里添加错误报告逻辑
    return null;
  }
}

// 使用示例
const video = await safeDatabaseOperation(
  () => databaseService.getVideoById(videoId),
  'Failed to get video'
);
```

### 2. 事务处理

```typescript
async function complexVideoOperation() {
  const db = databaseManager.getDatabase();
  
  try {
    const result = await db.transaction(async (tx) => {
      // 执行多个相关操作
      const video = await tx.insert(videoTable).values(videoData).returning();
      await tx.insert(watchHistoryTable).values(historyData);
      await tx.update(settingsTable).set(updateData);
      
      return video;
    });
    
    return result;
  } catch (error) {
    console.error('Transaction failed:', error);
    throw error;
  }
}
```

### 3. 性能优化

```typescript
// 使用索引优化查询
const optimizedSearch = await databaseService.searchVideos({
  query: 'search term',
  category: 'entertainment',
  sortBy: 'play_count',
  sortOrder: 'desc',
  page: 1,
  pageSize: 20,
});

// 批量操作
const videosToCreate = videoDataList.map(data => 
  databaseService.createVideo(data)
);
const createdVideos = await Promise.all(videosToCreate);
```

### 4. 内存管理

```typescript
// 及时清理大结果集
async function processLargeDataset() {
  const batchSize = 100;
  let page = 1;
  
  while (true) {
    const result = await databaseService.searchVideos({
      page,
      pageSize: batchSize,
    });
    
    // 处理当前批次
    await processBatch(result.items);
    
    if (!result.hasMore) break;
    page++;
  }
}
```

## 故障排除

### 1. 常见错误

```typescript
// 数据库未初始化
try {
  await databaseService.getVideoById(videoId);
} catch (error) {
  if (error.message.includes('Database not initialized')) {
    await databaseManager.initialize();
    // 重试操作
  }
}

// 迁移失败
try {
  await databaseManager.runMigrations();
} catch (error) {
  console.error('Migration failed:', error);
  // 可能需要手动修复数据库
}
```

### 2. 调试技巧

```typescript
// 启用详细日志
console.log('Database state:', await databaseManager.checkHealth());

// 检查特定表的数据
const videoCount = await databaseManager.getDatabase()
  .select({ count: sql`COUNT(*)` })
  .from(videoTable);
console.log('Total videos:', videoCount[0].count);
```

这些示例涵盖了数据库系统的主要功能和使用场景。根据具体需求，您可以进一步扩展和定制这些示例。